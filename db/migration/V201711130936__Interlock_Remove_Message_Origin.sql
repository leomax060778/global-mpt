CREATE COLUMN TABLE INTERLOCK_TYPE(
	INTERLOCK_TYPE_ID BIGINT NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    NAME NVARCHAR(255),
    DISPLAY_NAME NVARCHAR(255),
    CREATED_DATE_TZ TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    MODIFIED_DATE_TZ TIMESTAMP,
    CREATED_USER_ID BIGINT NOT NULL,
    MODIFIED_USER_ID BIGINT,
    ENABLED TINYINT DEFAULT 1,
    DELETED TINYINT DEFAULT 0,
    FOREIGN KEY ("CREATED_USER_ID") REFERENCES "MKTG_PLANNING_TOOL"."USER"("USER_ID")
);

INSERT INTO INTERLOCK_TYPE (INTERLOCK_TYPE_ID, NAME, DISPLAY_NAME, CREATED_USER_ID)
VALUES (1,'REQUEST_MONEY', 'Requester', 1);
INSERT INTO INTERLOCK_TYPE (INTERLOCK_TYPE_ID, NAME, DISPLAY_NAME, CREATED_USER_ID)
VALUES (2,'REGION_SPEND', 'Money Lender', 1);

ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_REQUEST" ADD (INTERLOCK_TYPE_ID BIGINT);

UPDATE INTERLOCK_REQUEST
SET INTERLOCK_REQUEST.INTERLOCK_TYPE_ID = T.INTERLOCK_REQUEST_ORIGIN_ID
FROM INTERLOCK_REQUEST INTERLOCK_REQUEST,
(SELECT IRM.INTERLOCK_REQUEST_ID, IRM.INTERLOCK_REQUEST_ORIGIN_ID
FROM INTERLOCK_REQUEST_MESSAGE IRM
WHERE IRM.CREATED_DATE_TZ IN
(SELECT MIN(IRM.CREATED_DATE_TZ)
FROM INTERLOCK_REQUEST IR
INNER JOIN INTERLOCK_REQUEST_MESSAGE IRM
ON IR.INTERLOCK_REQUEST_ID = IRM.INTERLOCK_REQUEST_ID
WHERE IR.ENABLED = 1 AND IR.DELETED = 0 AND IRM.ENABLED = 1 AND IRM.DELETED = 0
GROUP BY IR.INTERLOCK_REQUEST_ID)) T
WHERE INTERLOCK_REQUEST.INTERLOCK_REQUEST_ID = T.INTERLOCK_REQUEST_ID;

ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_CONFIGURATION" ADD (INTERLOCK_TYPE_ID BIGINT);

UPDATE INTERLOCK_DEFAULT_CONFIGURATION
SET INTERLOCK_TYPE_ID = INTERLOCK_REQUEST_ORIGIN_ID;

ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_CONFIGURATION" ADD FOREIGN KEY ( "INTERLOCK_TYPE_ID" )
REFERENCES "MKTG_PLANNING_TOOL"."INTERLOCK_TYPE" ("INTERLOCK_TYPE_ID") ON UPDATE RESTRICT ON DELETE RESTRICT;

CREATE PROCEDURE "MKTG_PLANNING_TOOL"."mktgplanningtool.db.procedures::DELETE_CONSTRAINT" (

	IN IN_TABLE_NAME NVARCHAR(255),
	IN IN_REFERENCED_TABLE_NAME NVARCHAR(255)

)
	LANGUAGE SQLSCRIPT
	SQL SECURITY INVOKER

	AS
BEGIN
   	DECLARE VALUE_CONSTRAINT NVARCHAR(255);
   	VALUE_CONSTRAINT := '';

	SELECT COALESCE(CONSTRAINT_NAME, '') INTO VALUE_CONSTRAINT from "SYS"."REFERENTIAL_CONSTRAINTS"
	WHERE TABLE_NAME = IN_TABLE_NAME AND REFERENCED_TABLE_NAME = IN_REFERENCED_TABLE_NAME
	AND SCHEMA_NAME = 'MKTG_PLANNING_TOOL';

	IF (:VALUE_CONSTRAINT <> '' )
	THEN
	exec 'ALTER TABLE '||:IN_TABLE_NAME||' DROP CONSTRAINT '||:VALUE_CONSTRAINT;
	COMMIT;
	END IF;

END;
--call procedure to delete FK
CALL "MKTG_PLANNING_TOOL"."mktgplanningtool.db.procedures::DELETE_CONSTRAINT"('INTERLOCK_DEFAULT_CONFIGURATION','INTERLOCK_REQUEST_ORIGIN');

--drop procedure from BD
DROP PROCEDURE "MKTG_PLANNING_TOOL"."mktgplanningtool.db.procedures::DELETE_CONSTRAINT" ;

ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_CONFIGURATION" alter (INTERLOCK_REQUEST_ORIGIN_ID BIGINT);
UPDATE INTERLOCK_DEFAULT_CONFIGURATION SET INTERLOCK_REQUEST_ORIGIN_ID = 0;
DELETE FROM INTERLOCK_REQUEST_ORIGIN;

ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_REQUEST_MESSAGE" DROP (INTERLOCK_REQUEST_ORIGIN_ID);
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_CONFIGURATION" DROP (INTERLOCK_REQUEST_ORIGIN_ID);
DROP TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_REQUEST_ORIGIN";

-- *************************************************************************************
-- Update schema version
INSERT INTO SCHEMA_VERSION(VERSION, DESCRIPTION, SCRIPT)
VALUES('V5.0.0-84', 'Interlock Remove Message Origin', 'V201711130936__Interlock_Remove_Message_Origin.sql');

COMMIT;