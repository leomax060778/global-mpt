--************************************
--************ CREATE Tables ************
--************************************

--************ Create EVENT_REQUEST_STATUS table ************
CREATE COLUMN TABLE "MKTG_PLANNING_TOOL"."EVENT_REQUEST_STATUS"(
	EVENT_REQUEST_STATUS_ID BIGINT NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
	NAME NVARCHAR(255),
	
	CREATED_USER_ID BIGINT NOT NULL,
	MODIFIED_USER_ID BIGINT,
	CREATED_DATE_TZ TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	MODIFIED_DATE_TZ TIMESTAMP,
	
	ENABLED TINYINT DEFAULT 1,
	DELETED TINYINT DEFAULT 0
);

--************ Create EVENT_REQUEST table ************
CREATE COLUMN TABLE "MKTG_PLANNING_TOOL"."EVENT_REQUEST"(
	EVENT_REQUEST_ID BIGINT NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
	EVENT_REQUEST_STATUS_ID BIGINT NOT NULL,
	HL4_ID BIGINT NOT NULL,
	HL5_ID BIGINT,
	NAME NVARCHAR(255) NOT NULL,
	START_DATE TIMESTAMP,
	END_DATE TIMESTAMP,
	CITY NVARCHAR(255),
	COUNTRY_ID BIGINT,
	VENUE NVARCHAR(255),
	EVENT_OWNER NVARCHAR(255),
	OBJECTIVE_ID BIGINT NOT NULL,
	CAMPAIGN_TYPE_ID BIGINT NOT NULL,
	CAMPAIGN_SUB_TYPE_ID BIGINT NOT NULL,
	DES_TYPE_ID BIGINT,
	SUMMARY NVARCHAR(255),
	
	PARTICIPANTS_NUMBER INTEGER,
	EXISTING_CUSTOMERS_PERCENTAGE DECIMAL(19,2),
	
	COST DECIMAL(19,2),
	PARTNER_REVENUE DECIMAL(19,2),
	MNP_VALUE DECIMAL(19,2),
	MNP_VOLUME INTEGER,
	
	CREATED_USER_ID BIGINT NOT NULL,
	MODIFIED_USER_ID BIGINT,
	CREATED_DATE_TZ TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	MODIFIED_DATE_TZ TIMESTAMP,
	
	ENABLED TINYINT DEFAULT 1,
	DELETED TINYINT DEFAULT 0,
	
	FOREIGN KEY ( "HL4_ID" ) REFERENCES "MKTG_PLANNING_TOOL"."HL4" ("HL4_ID"),
	FOREIGN KEY ( "CREATED_USER_ID" ) REFERENCES "MKTG_PLANNING_TOOL"."USER" ("USER_ID"),
	FOREIGN KEY ( "EVENT_REQUEST_STATUS_ID" ) REFERENCES "MKTG_PLANNING_TOOL"."EVENT_REQUEST_STATUS" ("EVENT_REQUEST_STATUS_ID"),
	FOREIGN KEY ( "OBJECTIVE_ID" ) REFERENCES "MKTG_PLANNING_TOOL"."OBJECTIVE" ("OBJECTIVE_ID"),
	FOREIGN KEY ( "CAMPAIGN_TYPE_ID" ) REFERENCES "MKTG_PLANNING_TOOL"."CAMPAIGN_TYPE" ("CAMPAIGN_TYPE_ID"),
	FOREIGN KEY ( "CAMPAIGN_SUB_TYPE_ID" ) REFERENCES "MKTG_PLANNING_TOOL"."CAMPAIGN_SUB_TYPE" ("CAMPAIGN_SUB_TYPE_ID")
);

--************ Create CUSTOMER_DEMOGRAPHICS table ************

CREATE COLUMN TABLE "MKTG_PLANNING_TOOL"."CUSTOMER_DEMOGRAPHICS"(
	CUSTOMER_DEMOGRAPHICS_ID BIGINT NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
	NAME NVARCHAR(40) NOT NULL,
	
	CREATED_USER_ID BIGINT NOT NULL,
	MODIFIED_USER_ID BIGINT,
	CREATED_DATE_TZ TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	MODIFIED_DATE_TZ TIMESTAMP,
	
	ENABLED TINYINT DEFAULT 1,
	DELETED TINYINT DEFAULT 0,
	
	FOREIGN KEY ( "CREATED_USER_ID" ) REFERENCES "MKTG_PLANNING_TOOL"."USER" ("USER_ID")
);

--************ Create EVENT_REQUEST_CUSTOMER_DEMOGRAPHICS table ************

CREATE COLUMN TABLE "MKTG_PLANNING_TOOL"."EVENT_REQUEST_CUSTOMER_DEMOGRAPHICS"(
	EVENT_REQUEST_CUSTOMER_DEMOGRAPHICS_ID BIGINT NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
	EVENT_REQUEST_ID BIGINT NOT NULL,
	CUSTOMER_DEMOGRAPHICS_ID BIGINT NOT NULL,
	
	CREATED_USER_ID BIGINT NOT NULL,
	MODIFIED_USER_ID BIGINT,
	CREATED_DATE_TZ TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	MODIFIED_DATE_TZ TIMESTAMP,
	
	ENABLED TINYINT DEFAULT 1,
	DELETED TINYINT DEFAULT 0,
	
	FOREIGN KEY ( "CREATED_USER_ID" ) REFERENCES "MKTG_PLANNING_TOOL"."USER" ("USER_ID"),
	FOREIGN KEY ( "EVENT_REQUEST_ID" ) REFERENCES "MKTG_PLANNING_TOOL"."EVENT_REQUEST" ("EVENT_REQUEST_ID"),
	FOREIGN KEY ( "CUSTOMER_DEMOGRAPHICS_ID" ) REFERENCES "MKTG_PLANNING_TOOL"."CUSTOMER_DEMOGRAPHICS" ("CUSTOMER_DEMOGRAPHICS_ID")
);

--************ Create EVENT_REQUEST_CATEGORY_OPTION table ************

CREATE COLUMN TABLE "MKTG_PLANNING_TOOL"."EVENT_REQUEST_CATEGORY_OPTION"(
	EVENT_REQUEST_CATEGORY_OPTION_ID BIGINT NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
	EVENT_REQUEST_ID BIGINT NOT NULL,
	
	ALLOCATION_CATEGORY_OPTION_LEVEL_ID BIGINT NOT NULL,
	PERCENTAGE DECIMAL(19,2) NOT NULL,
	
	CREATED_USER_ID BIGINT NOT NULL,
	MODIFIED_USER_ID BIGINT,
	CREATED_DATE_TZ TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	MODIFIED_DATE_TZ TIMESTAMP,
	
	ENABLED TINYINT DEFAULT 1,
	DELETED TINYINT DEFAULT 0,
	
	FOREIGN KEY ( "CREATED_USER_ID" ) REFERENCES "MKTG_PLANNING_TOOL"."USER" ("USER_ID"),
	FOREIGN KEY ( "EVENT_REQUEST_ID" ) REFERENCES "MKTG_PLANNING_TOOL"."EVENT_REQUEST" ("EVENT_REQUEST_ID"),
	FOREIGN KEY ( "ALLOCATION_CATEGORY_OPTION_LEVEL_ID" ) REFERENCES "MKTG_PLANNING_TOOL"."ALLOCATION_CATEGORY_OPTION_LEVEL" ("ALLOCATION_CATEGORY_OPTION_LEVEL_ID")
);

--************************************
--************ Alter ALLOCATION_CATEGORY_OPTION_LEVEL to add new Flag ************
--************************************

ALTER TABLE "MKTG_PLANNING_TOOL"."ALLOCATION_CATEGORY_OPTION_LEVEL" ADD (AVAILABLE_IN_EVENT_REQUEST TINYINT DEFAULT 0);

UPDATE "MKTG_PLANNING_TOOL"."ALLOCATION_CATEGORY_OPTION_LEVEL" SET
AVAILABLE_IN_EVENT_REQUEST = 1
WHERE HIERARCHY_LEVEL_ID = 2
AND ALLOCATION_CATEGORY_ID IN (SELECT ALLOCATION_CATEGORY_ID FROM ALLOCATION_CATEGORY WHERE NAME IN (
'Industries'
, 'Marketing Priorities (LOBs)'
, 'Marketing Segment'
) AND DELETED = 0 AND ENABLED = 1)
AND ENABLED = 1
AND DELETED = 0;

--************************************
--************ Populate Tables ************
--************************************

--************ EVENT_REQUEST_STATUS ************

INSERT INTO "MKTG_PLANNING_TOOL"."EVENT_REQUEST_STATUS" (EVENT_REQUEST_STATUS_ID, NAME, CREATED_USER_ID)
	VALUES(1, 'Pending', 1);
INSERT INTO "MKTG_PLANNING_TOOL"."EVENT_REQUEST_STATUS" (EVENT_REQUEST_STATUS_ID, NAME, CREATED_USER_ID)
	VALUES(2, 'Approved', 1);
INSERT INTO "MKTG_PLANNING_TOOL"."EVENT_REQUEST_STATUS" (EVENT_REQUEST_STATUS_ID, NAME, CREATED_USER_ID)
	VALUES(3, 'Rejected', 1);
	
--************ CUSTOMER_DEMOGRAPHICS ************

INSERT INTO "MKTG_PLANNING_TOOL"."CUSTOMER_DEMOGRAPHICS" (CUSTOMER_DEMOGRAPHICS_ID, NAME, CREATED_USER_ID)
	VALUES(1, 'C-level', 1);
INSERT INTO "MKTG_PLANNING_TOOL"."CUSTOMER_DEMOGRAPHICS" (CUSTOMER_DEMOGRAPHICS_ID, NAME, CREATED_USER_ID)
	VALUES(2, 'D-level', 1);
INSERT INTO "MKTG_PLANNING_TOOL"."CUSTOMER_DEMOGRAPHICS" (CUSTOMER_DEMOGRAPHICS_ID, NAME, CREATED_USER_ID)
	VALUES(3, 'E-level', 1);

--************************************
--************ Alter HL5, HL6 to add new Flag ************
--************************************
ALTER TABLE "MKTG_PLANNING_TOOL"."HL5" ADD (INHERITED_CREATION TINYINT DEFAULT 0);
ALTER TABLE "MKTG_PLANNING_TOOL"."HL6" ADD (INHERITED_CREATION TINYINT DEFAULT 0);
--************************************
--************ Alter Campaign Types,to add new Flag ************
--************************************
ALTER TABLE "MKTG_PLANNING_TOOL"."CAMPAIGN_TYPE" ADD (USE_IN_EVENT_REQUEST TINYINT DEFAULT 0);

-- Update schema version
INSERT INTO SCHEMA_VERSION(VERSION, DESCRIPTION, SCRIPT)
VALUES('V5.0.0-125', 'Create Event Request tables', 'V201803271310__Create_Event_Request_tables.sql');

COMMIT;