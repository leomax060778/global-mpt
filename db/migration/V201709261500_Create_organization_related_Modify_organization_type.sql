-- Create ORGANIZATION_RELATED table
CREATE COLUMN TABLE "MKTG_PLANNING_TOOL"."ORGANIZATION_RELATED" (
        "ORGANIZATION_RELATED_ID" bigint not null primary key generated by default as IDENTITY,
        "NAME" nvarchar(255) not null,
		"DESCRIPTION" nvarchar(300),
		
        "CREATED_DATE_TZ" timestamp default CURRENT_TIMESTAMP,
        "MODIFIED_DATE_TZ" timestamp,
        "CREATED_USER_ID" bigint not null,
        "MODIFIED_USER_ID" bigint,
        "ENABLED" tinyint default 1,
        "DELETED" tinyint default 0,
		
        FOREIGN KEY ("CREATED_USER_ID") REFERENCES "MKTG_PLANNING_TOOL"."USER"("USER_ID")
);

-- Insert basic information to the new table
INSERT INTO "MKTG_PLANNING_TOOL"."ORGANIZATION_RELATED" (ORGANIZATION_RELATED_ID, NAME, DESCRIPTION, CREATED_USER_ID)
	VALUES(1, 'Global', 'Organizations related to the INTERLOCK_ORGANIZATION table', 1);
INSERT INTO "MKTG_PLANNING_TOOL"."ORGANIZATION_RELATED" (ORGANIZATION_RELATED_ID, NAME, DESCRIPTION, CREATED_USER_ID)
	VALUES(2, 'Region', 'Organizations related to the REGION table', 1);
INSERT INTO "MKTG_PLANNING_TOOL"."ORGANIZATION_RELATED" (ORGANIZATION_RELATED_ID, NAME, DESCRIPTION, CREATED_USER_ID)
	VALUES(3, 'Subregion', 'Organizations related to the SUBREGION table', 1);
	
-- Clean ORGANIZATION_TYPE
DELETE FROM  "MKTG_PLANNING_TOOL"."ORGANIZATION_TYPE_INTERLOCK_ORGANIZATION";
DELETE FROM "MKTG_PLANNING_TOOL"."ORGANIZATION_TYPE";

-- Replaced TYPE to ORGANIZATION_RELATED_ID
ALTER TABLE "MKTG_PLANNING_TOOL"."ORGANIZATION_TYPE" DROP (TYPE);
ALTER TABLE "MKTG_PLANNING_TOOL"."ORGANIZATION_TYPE" ADD(ORGANIZATION_RELATED_ID BIGINT);

-- Insert Basic information for ORGANIZATION_TYPE
INSERT INTO "MKTG_PLANNING_TOOL"."ORGANIZATION_TYPE"(ORGANIZATION_TYPE_ID, NAME, ORGANIZATION_RELATED_ID, CREATED_USER_ID)
	VALUES(1, 'Central Teams', 1, 1);
	
INSERT INTO "MKTG_PLANNING_TOOL"."ORGANIZATION_TYPE"(ORGANIZATION_TYPE_ID, NAME, ORGANIZATION_RELATED_ID, CREATED_USER_ID)
	VALUES(2, 'Regions', 2, 1);
	
INSERT INTO "MKTG_PLANNING_TOOL"."ORGANIZATION_TYPE"(ORGANIZATION_TYPE_ID, NAME, ORGANIZATION_RELATED_ID, CREATED_USER_ID)
	VALUES(3, 'Market Unit', 3, 1);

--add Interlock permissions
--all permissions for SupAdmin and read/view and create for ADMIN
insert into "MKTG_PLANNING_TOOL"."RESOURCE" (NAME,CREATED_USER_ID,OBJECT_NAME) values('Interlock',1,'Interlock');
insert into "MKTG_PLANNING_TOOL"."ROLE_PERMISSION"(role_id, resource_id, permission_id, created_user_id) values(1, (SELECT RESOURCE_ID FROM RESOURCE where NAME='Interlock'), 9, 1);
insert into "MKTG_PLANNING_TOOL"."ROLE_PERMISSION"(role_id, resource_id, permission_id, created_user_id) values(1, (SELECT RESOURCE_ID FROM RESOURCE where NAME='Interlock'), 10, 1);
insert into "MKTG_PLANNING_TOOL"."ROLE_PERMISSION"(role_id, resource_id, permission_id, created_user_id) values(1, (SELECT RESOURCE_ID FROM RESOURCE where NAME='Interlock'), 11, 1);
insert into "MKTG_PLANNING_TOOL"."ROLE_PERMISSION"(role_id, resource_id, permission_id, created_user_id) values(2, (SELECT RESOURCE_ID FROM RESOURCE where NAME='Interlock'), 9, 1);
insert into "MKTG_PLANNING_TOOL"."ROLE_PERMISSION"(role_id, resource_id, permission_id, created_user_id) values(2, (SELECT RESOURCE_ID FROM RESOURCE where NAME='Interlock'), 10, 1);
--insert into "MKTG_PLANNING_TOOL"."ROLE_PERMISSION"(role_id, resource_id, permission_id, created_user_id) values(3, (SELECT RESOURCE_ID FROM RESOURCE where NAME='Interlock'), 9, 1);
--insert into "MKTG_PLANNING_TOOL"."ROLE_PERMISSION"(role_id, resource_id, permission_id, created_user_id) values(3, (SELECT RESOURCE_ID FROM RESOURCE where NAME='Interlock'), 10, 1);
--insert into "MKTG_PLANNING_TOOL"."ROLE_PERMISSION"(role_id, resource_id, permission_id, created_user_id) values(4, (SELECT RESOURCE_ID FROM RESOURCE where NAME='Interlock'), 9, 1);
--insert into "MKTG_PLANNING_TOOL"."ROLE_PERMISSION"(role_id, resource_id, permission_id, created_user_id) values(4, (SELECT RESOURCE_ID FROM RESOURCE where NAME='Interlock'), 10, 1);

ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_REQUEST_INTERLOCK_ORGANIZATION" ADD(INTERLOCK_ORGANIZATION_ID_FROM BIGINT);
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_REQUEST_INTERLOCK_ORGANIZATION" ADD FOREIGN KEY ( "INTERLOCK_ORGANIZATION_ID_FROM" ) REFERENCES "MKTG_PLANNING_TOOL"."INTERLOCK_ORGANIZATION" ("INTERLOCK_ORGANIZATION_ID") ON UPDATE RESTRICT ON DELETE RESTRICT;

ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_REQUEST_REGION" ADD (REGION_ID_FROM BIGINT);
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_REQUEST_REGION" ADD FOREIGN KEY ( "REGION_ID_FROM" ) REFERENCES "MKTG_PLANNING_TOOL"."REGION" ("REGION_ID") ON UPDATE RESTRICT ON DELETE RESTRICT;

ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_REQUEST_SUBREGION" ADD (SUBREGION_ID_FROM BIGINT);
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_REQUEST_SUBREGION" ADD FOREIGN KEY ( "SUBREGION_ID_FROM" ) REFERENCES "MKTG_PLANNING_TOOL"."SUBREGION" ("SUBREGION_ID") ON UPDATE RESTRICT ON DELETE RESTRICT;

ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_REQUEST_INTERLOCK_ORGANIZATION" ALTER (INTERLOCK_ORGANIZATION_ID bigint NULL);
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_REQUEST_REGION" ALTER (REGION_ID bigint NULL);
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_REQUEST_SUBREGION" ALTER (SUBREGION_ID bigint NULL);

ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_REQUEST" ADD (ENTITY_ID_FROM BIGINT);
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_REQUEST" ADD FOREIGN KEY ("ENTITY_ID_FROM") REFERENCES "MKTG_PLANNING_TOOL"."INTERLOCK_ENTITY" ("INTERLOCK_ENTITY_ID") ON UPDATE RESTRICT ON DELETE RESTRICT;

ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_REQUEST" ADD (ORGANIZATION_TYPE_ID_FROM BIGINT);
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_REQUEST" ADD FOREIGN KEY ("ORGANIZATION_TYPE_ID_FROM") REFERENCES "MKTG_PLANNING_TOOL"."ORGANIZATION_TYPE" ("ORGANIZATION_TYPE_ID") ON UPDATE RESTRICT ON DELETE RESTRICT;

--table to interlock report
DROP TABLE "MKTG_PLANNING_TOOL"."CV_INTERLOCK_REPORT_DATA";
CREATE COLUMN TABLE "MKTG_PLANNING_TOOL"."CV_INTERLOCK_REPORT_DATA"(
         "ORGANIZATION_TYPE_NAME_FROM" NVARCHAR(255)
        ,"ORGANIZATION_NAME_FROM" NVARCHAR(255)
        ,"INTERLOCK_ENTITY_NAME_FROM" NVARCHAR(255)
        ,"ACTION" NVARCHAR(255)
        ,"ORGANIZATION_TYPE_NAME_TO" NVARCHAR(255)
        ,"ORGANIZATION_NAME_TO" NVARCHAR(255)
        ,"INTERLOCK_ENTITY_NAME_TO" NVARCHAR(255)
        ,"REQUESTED_RESOURCE" NVARCHAR(255)
        ,"REQUESTED_BUDGET" DECIMAL(19, 10) NOT NULL
        ,"STATUS_DETAIL" NVARCHAR(255)
        ,"CREATED_DATE" LONGDATE
        ,"STATUS_CHANGE_DATE" LONGDATE
        ,"REQUESTER" NVARCHAR(255)
        ,"CONTACT_DATA" NVARCHAR(255)
);

-- Update schema version
INSERT INTO SCHEMA_VERSION(VERSION, DESCRIPTION, SCRIPT)
VALUES('V5.0.0-69', 'Create ORGANIZATION_RELATED, modified ORGANIZATION_TYPE to conect it with the new Table', 'V201709261500_Create_organization_related_Modify_organization_type.sql');

COMMIT;