-- New table to store all selected Entities "FROM" available to be selected as default in the Interlock Process View
CREATE COLUMN TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_ENTITY_CONFIGURATION_FROM"
(
	INTERLOCK_DEFAULT_ENTITY_CONFIGURATION_FROM_ID BIGINT NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
	ENTITY_ID BIGINT NOT NULL,
	INTERLOCK_TYPE_ID BIGINT NOT NULL,

	CREATED_DATE_TZ TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	MODIFIED_DATE_TZ TIMESTAMP,
	CREATED_USER_ID BIGINT NOT NULL,
	MODIFIED_USER_ID BIGINT,
	ENABLED TINYINT DEFAULT 1,
	DELETED TINYINT DEFAULT 0
);
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_ENTITY_CONFIGURATION_FROM" ADD FOREIGN KEY ( "ENTITY_ID" ) REFERENCES "MKTG_PLANNING_TOOL"."INTERLOCK_ENTITY" ("INTERLOCK_ENTITY_ID") ON UPDATE RESTRICT ON DELETE RESTRICT;

-- New table to store all selected Entities "TO" available to be selected as default in the Interlock Process View
CREATE COLUMN TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_ENTITY_CONFIGURATION_TO"
(
	INTERLOCK_DEFAULT_ENTITY_CONFIGURATION_TO_ID BIGINT NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
	ENTITY_ID BIGINT NOT NULL,
	INTERLOCK_TYPE_ID BIGINT NOT NULL,

	CREATED_DATE_TZ TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	MODIFIED_DATE_TZ TIMESTAMP,
	CREATED_USER_ID BIGINT NOT NULL,
	MODIFIED_USER_ID BIGINT,
	ENABLED TINYINT DEFAULT 1,
	DELETED TINYINT DEFAULT 0
);
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_ENTITY_CONFIGURATION_TO" ADD FOREIGN KEY ( "ENTITY_ID" ) REFERENCES "MKTG_PLANNING_TOOL"."INTERLOCK_ENTITY" ("INTERLOCK_ENTITY_ID") ON UPDATE RESTRICT ON DELETE RESTRICT;

-- New table to store all selected Organization Types "FROM" available to be selected as default in the Interlock Process View
CREATE COLUMN TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_ORGANIZATION_TYPE_CONFIGURATION_FROM"
(
	INTERLOCK_DEFAULT_ORGANIZATION_TYPE_CONFIGURATION_FROM_ID BIGINT NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
	ORGANIZATION_TYPE_ID BIGINT NOT NULL,
	INTERLOCK_TYPE_ID BIGINT NOT NULL,

	CREATED_DATE_TZ TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	MODIFIED_DATE_TZ TIMESTAMP,
	CREATED_USER_ID BIGINT NOT NULL,
	MODIFIED_USER_ID BIGINT,
	ENABLED TINYINT DEFAULT 1,
	DELETED TINYINT DEFAULT 0
);
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_ORGANIZATION_TYPE_CONFIGURATION_FROM" ADD FOREIGN KEY ( "ORGANIZATION_TYPE_ID" ) REFERENCES "MKTG_PLANNING_TOOL"."ORGANIZATION_TYPE" ("ORGANIZATION_TYPE_ID") ON UPDATE RESTRICT ON DELETE RESTRICT;

-- New table to store all selected Organization Types "TO" available to be selected as default in the Interlock Process View
CREATE COLUMN TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_ORGANIZATION_TYPE_CONFIGURATION_TO"
(
	INTERLOCK_DEFAULT_ORGANIZATION_TYPE_CONFIGURATION_TO_ID BIGINT NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
	ORGANIZATION_TYPE_ID BIGINT NOT NULL,
	INTERLOCK_TYPE_ID BIGINT NOT NULL,

	CREATED_DATE_TZ TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	MODIFIED_DATE_TZ TIMESTAMP,
	CREATED_USER_ID BIGINT NOT NULL,
	MODIFIED_USER_ID BIGINT,
	ENABLED TINYINT DEFAULT 1,
	DELETED TINYINT DEFAULT 0
);
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_ORGANIZATION_TYPE_CONFIGURATION_TO" ADD FOREIGN KEY ( "ORGANIZATION_TYPE_ID" ) REFERENCES "MKTG_PLANNING_TOOL"."ORGANIZATION_TYPE" ("ORGANIZATION_TYPE_ID") ON UPDATE RESTRICT ON DELETE RESTRICT;

-- *************************************************************************************

-- Delete old information, not necesary anymore
DELETE FROM "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_CONFIGURATION";

-- Drop deprecated columns from INTERLOCK_DEFAULT_CONFIGURATION

/*
------- IMPORTANT: make sure to use this script to delete the generated Constraints before executing the rest of the script -------

select * from "REFERENTIAL_CONSTRAINTS"
where TABLE_NAME = 'INTERLOCK_DEFAULT_CONFIGURATION'
order by COLUMN_NAME

ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_CONFIGURATION" DROP CONSTRAINT _SYS_CONSTRAINT_957625_#0_#F1; --FOR ENTITY_ID_FROM, replace the constraint name with the correct one
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_CONFIGURATION" DROP CONSTRAINT _SYS_CONSTRAINT_957625_#0_#F2; --FOR ENTITY_ID_TO, replace the constraint name with the correct one
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_CONFIGURATION" DROP CONSTRAINT _SYS_CONSTRAINT_957625_#0_#F3; --FOR ORGANIZATION_TYPE_FROM, replace the constraint name with the correct one
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_CONFIGURATION" DROP CONSTRAINT _SYS_CONSTRAINT_957625_#0_#F4; --FOR ORGANIZATION_TYPE_TO, replace the constraint name with the correct one
*/

-- Drop deprecated columns
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_CONFIGURATION" DROP (ENTITY_ID_FROM);
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_CONFIGURATION" DROP (ENTITY_ID_TO);
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_CONFIGURATION" DROP (ORGANIZATION_TYPE_FROM);
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_CONFIGURATION" DROP (ORGANIZATION_TYPE_TO);

-- Add new column
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_CONFIGURATION" ADD (ENABLE_DEFAULT_SELECTION TINYINT DEFAULT 0);

-- Set default values
INSERT INTO "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_CONFIGURATION" (INTERLOCK_DEFAULT_CONFIGURATION_ID, INTERLOCK_TYPE_ID, CREATED_USER_ID)
	VALUES(1,1,1);

INSERT INTO "MKTG_PLANNING_TOOL"."INTERLOCK_DEFAULT_CONFIGURATION" (INTERLOCK_DEFAULT_CONFIGURATION_ID, INTERLOCK_TYPE_ID, CREATED_USER_ID)
	VALUES(2,2,1);


-- ******************************************************************************
--CONTACT DATA

CREATE COLUMN TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_ORGANIZATION_CONTACT_DATA"
(
	INTERLOCK_ORGANIZATION_CONTACT_DATA_ID BIGINT NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
	ORGANIZATION_RELATED_ID BIGINT NOT NULL,
	ORGANIZATION_ID BIGINT NOT NULL,
	CONTACT_DATA_ID BIGINT NOT NULL,

	CREATED_DATE_TZ TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	MODIFIED_DATE_TZ TIMESTAMP,
	CREATED_USER_ID BIGINT NOT NULL,
	MODIFIED_USER_ID BIGINT,
	ENABLED TINYINT DEFAULT 1,
	DELETED TINYINT DEFAULT 0
);
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_ORGANIZATION_CONTACT_DATA" ADD FOREIGN KEY ( "CREATED_USER_ID" ) REFERENCES "MKTG_PLANNING_TOOL"."USER" ("USER_ID") ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_ORGANIZATION_CONTACT_DATA" ADD FOREIGN KEY ( "ORGANIZATION_RELATED_ID" ) REFERENCES "MKTG_PLANNING_TOOL"."ORGANIZATION_RELATED" ("ORGANIZATION_RELATED_ID") ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE "MKTG_PLANNING_TOOL"."INTERLOCK_ORGANIZATION_CONTACT_DATA" ADD FOREIGN KEY ( "CONTACT_DATA_ID" ) REFERENCES "MKTG_PLANNING_TOOL"."USER" ("USER_ID") ON UPDATE RESTRICT ON DELETE RESTRICT;


-- *************************************************************************************
-- Update schema version

INSERT INTO SCHEMA_VERSION(VERSION, DESCRIPTION, SCRIPT)
VALUES('V5.0.0-88', 'Create New Interlock Configuration tables', 'V201711141700__Create_tables_for_interlock_configuration.sql');

COMMIT;